#!/bin/bash

export PATH=/usr/bin:/bin:"$PATH"

LIB_DIR=$(dirname "$0")
ROLLOUT_DIR=$(dirname "$LIB_DIR")
VAR_DIR=/tmp/rollout_var

ERROR_wrongArguments=("exit=1" "message=Got an incorrect command line argument" "xcode_alert=error")
ERROR_appKeyMissing=("exit=2" "message=app_key argument is required" "xcode_alert=error")
ERROR_wrongSelfVersion=("exit=3" "message=Incorrect SDK version" "xcode_alert=error")
ERROR_couldNotSplitDsym=("exit=12" "message=Couldn't split dSYM. Please contact us at support@rollout.io" "xcode_alert=error")
ERROR_couldNotSplitExecutable=("exit=13" "message=Couldn't split executable. Please contact us at support@rollout.io" "xcode_alert=error")
ERROR_missingDsym=("exit=14" "message=Missing dSYM. Please contact us at support@rollout.io" "xcode_alert=error")
ERROR_missingExecutable=("exit=15" "message=Missing executable. Please contact us at support@rollout.io" "xcode_alert=error")
ERROR_lipoInfoFailed=("exit=16" "message=Could not parse 'lipo -info' output. Please contact us at support@rollout.io" "xcode_alert=error")
ERROR_dsym2protoFailed=("exit=17" "message=dsym2proto failed. Please contact us at support@rollout.io" "xcode_alert=error")
ERROR_dsymAndExecMismatch=("exit=18" "message=The dSYM and the executable have different UUIDs. Please contact us at support@rollout.io" "xcode_alert=error")
ERROR_missingProto=("exit=18" "message=The proto data file is missing. Please contact us at support@rollout.io" "xcode_alert=error")
handle_error() { #{{{
  eval local error=('"${'$1'[@]}"')
  local details="$2"
  local exit=""
  local message=""
  local xcode_alert=""
  local no_report=""
  for param in "${error[@]}"; do eval ${param%=*}=\"${param#*=}\"; done

  [ -z "$details" ] || message="$message: $details"

  [ -z "$xcode_alert" ] || echo "$xcode_alert: $message" 1>&2
  [ -n "$no_report" ] || echo "tweaker error:" "$message" 1>&2
  [ -z "$exit" ] || exit $exit
} #}}}

dsym_file_from_path() { #{{{
  echo "$1"/Contents/Resources/DWARF/*
} #}}}

get_overridable_rollout_tool() {
  local tool=$1
  local override_name=ROLLOUT_overridableTool_$tool
  local override_tool=${!override_name}
  [ -n "$override_tool" ] && echo $override_tool || echo "$LIB_DIR"/$tool
}

get_UUID() {
  xcrun dwarfdump -u $1 | awk '{print$2}'
}

unset app_key help exit disable_upload
while getopts "k:hm" option; do #{{{
  case $option in
    k)
      app_key=$OPTARG
      ;;
    m)
      disable_upload=1
      ;;
    h)
      help=1
      ;;
    *)
      exit=1
      ;;
  esac
done #}}}

[ -z "$help" ] || { #{{{
  cat << EOF
Usage:
$0 <options>

  -k <app key>           Rollout app key (required)
  -m                     disable uploading of dsym to Rollout server
  -h                     this help message
EOF
  exit
} #}}}

[ -z "$exit" ] || handle_error ERROR_wrongArguments

[ -n "$app_key" ] || handle_error ERROR_appKeyMissing

rollout_build=`(. "$LIB_DIR"/versions; echo $build)`
echo "Rollout.io upload_dsym_phase (Rollout SDK build $build)"

xcodeproj_configuration=`(. "$LIB_DIR"/versions; echo $xcodeproj_configuration)`
[ 0$ROLLOUT_lastXcodeprojConfiguration -ge $xcodeproj_configuration ] || {
  cat << end_of_error_msg
Rollout.io SDK version was not reconfigured, aborting...
Our guess is that you changed Rollout.io version in your podfile, but have not reconfigured it yet.
If this is correct, please run the following command:
    "$ROLLOUT_DIR"/install/configure_pod.sh -k $app_key

If our guess is incorrect or if the above didn't help, please contact us at support@rollout.io
end_of_error_msg
  handle_error ERROR_wrongSelfVersion
} #' (sublime goes crazy on unpaired single quote...)

mkdir -p "$VAR_DIR"
temp_dir=`mktemp -d $VAR_DIR/temp.XXX`

target="$CODESIGNING_FOLDER_PATH/$EXECUTABLE_NAME"
dsym_file=`dsym_file_from_path "$DWARF_DSYM_FOLDER_PATH/$DWARF_DSYM_FILE_NAME"`
if [ -f "$dsym_file" ] && [ `stat -f "%m" "$dsym_file"` -ge `stat -f "%m" "$target"` ]; then
  echo "Rollout: using dsym generated by Xcode: \"$dsym_file\""
else
  echo "Rollout: will generate dsyms"
  dsym_path="$temp_dir"/dsym.dSYM
  xcrun dsymutil "$target" -o "$dsym_path" > /dev/null 2>&1
  dsym_file=`dsym_file_from_path "$dsym_path"`
fi

[ -f "$dsym_file" ] || handle_error ERROR_missingDsym

[ `(. "$LIB_DIR"/versions; echo $lib | cut -d- -f1)` != SwiftBeta -a "$CONFIGURATION" != "Debug-SwiftMilestone" ] || {
  echo "In Swift-beta part"
  executable_file=${SYMROOT}/${CONFIGURATION}-${PLATFORM_NAME}/${PRODUCT_NAME}.app/${PRODUCT_NAME}
  lipo_info=`xcrun lipo -info "$dsym_file" | head -1`
  lipo_archs=${lipo_info##*:}
  split_by_arch="$temp_dir/archs"
  mkdir $split_by_arch
  if echo "$lipo_info" | grep "^Architectures in the fat file: " > /dev/null; then
    for arch in $lipo_archs; do
      arch_dir=$split_by_arch/$arch
      mkdir $arch_dir
      xcrun lipo -thin $arch -output $arch_dir/dsym "$dsym_file" || handle_error ERROR_couldNotSplitDsym
      xcrun lipo -thin $arch -output $arch_dir/executable "$executable_file" || handle_error ERROR_couldNotSplitExecutable
    done
  elif echo "$lipo_info" | grep "^Non-fat file: " > /dev/null; then
    arch=`echo $lipo_archs`
    arch_dir=$split_by_arch/$arch
    mkdir $arch_dir
    ln -s "$dsym_file" $arch_dir/dsym
    ln -s "$executable_file" $arch_dir/executable
  else
    handle_error ERROR_lipoInfoFailed
  fi

  debug_info_file_name=rollout_swift_debug_info
  dsym2proto="`get_overridable_rollout_tool dsym2proto`"
  for arch_dir in "$split_by_arch"/*; do
    arch=`basename "$arch_dir"`
    executable_uuid=`get_UUID $arch_dir/executable`
    dsym_uuid=`get_UUID $arch_dir/dsym`
    [ -n "$executable_uuid" -a $executable_uuid == $dsym_uuid ] || handle_error ERROR_dsymAndExecMismatch
    echo "Running dsym2proto for ${arch}.."
    temp_proto_parent=$temp_dir/temp_proto.$arch
    mkdir $temp_proto_parent
    "$dsym2proto" --include-names --input-dsym $arch_dir/dsym --input-binary $arch_dir/executable --output-dir $temp_proto_parent || handle_error ERROR_dsym2protoFailed
    mv $temp_proto_parent/$executable_uuid.bin $temp_dir/$debug_info_file_name.$arch || handle_error ERROR_missingProto
  done

  # Ticket #1644: replace the following line with the joining to fat data file;
  #               if dsym2proto accepts multiple pairs of exec+dsym, then update the call to dsym2proto above too
  all_infos=($temp_dir/$debug_info_file_name.*) && cp ${all_infos[0]} $temp_dir/$debug_info_file_name

  cp -v $temp_dir/$debug_info_file_name  "${CONFIGURATION_BUILD_DIR}/${UNLOCALIZED_RESOURCES_FOLDER_PATH}/"
  if [ -d "${INSTALL_DIR}/${UNLOCALIZED_RESOURCES_FOLDER_PATH}" ]; then
    echo "Rollout: Installation mode, special copy" 
    cp -v $temp_dir/$debug_info_file_name  "${INSTALL_DIR}/${UNLOCALIZED_RESOURCES_FOLDER_PATH}"
  fi
}

if [ -z "$disable_upload" ]; then
  dsym_session_id=$RANDOM
  named_dsym="$VAR_DIR"/dsym__"$app_key"__`date +"%Y-%m-%d_%H:%M:%S"`__$dsym_session_id.dsym
  cp "$dsym_file" "$named_dsym"
  echo "Going to upload the dsym in the background. Session id: $dsym_session_id, dsym path: \"$named_dsym\""
  (
    echo "`date +"%Y-%m-%d_%H:%M:%S"`: session $dsym_session_id started (-k $app_key -d \"$named_dsym\")"
    "$LIB_DIR"/upload_dsym -k $app_key -d "$named_dsym"
    rm "$named_dsym"
    echo "`date +"%Y-%m-%d_%H:%M:%S"`: session $dsym_session_id finished"
  ) >> "$VAR_DIR"/upload_dsym.log 2>&1 &
else
  echo "Dsym uploading disabled"
fi

rm -rf $temp_dir